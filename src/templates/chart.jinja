{% set chartcolors = [
    "75, 192, 192",
    "192, 75, 192",
    "192, 192, 75",
    "75, 75, 192",
    "192, 75, 75",
    "75, 192, 75",
    "75, 75, 75",
    "192, 192, 192",
    "255, 255, 255",
    "255, 75, 75",
    "75, 75, 255",
    "75, 255, 75",
] %}

{% set default_chartdata = {
    "Test data": "[
        {x: '2024-01-01', y: 100},
        {x: '2024-01-15', y: 100},
        {x: '2024-03-01', y: 200},
    ]",
    "Test data2": "[
        {x: '2024-02-01', y: 175},
    ]",
} %}

{% macro create_dataset(name, color, data) %}
{
    label: "{{name}}",
    data: {{data}},
    tension: 0.1,
    borderColor: 'rgb({{color}})',
    fill: true,
    backgroundColor: (ctx) => {
        const chart = ctx.chart;

        const gradient = chart.ctx.createLinearGradient(0, 0, 0, chart.height);
        gradient.addColorStop(0, "rgba({{color}}, 0.2)");
        gradient.addColorStop(1, "rgba({{color}}, 0)");

        return gradient;
    },
    spanGaps: true,
}
{% endmacro %}

{% macro build_canvas(name="myChart", chartdata=default_chartdata) %}
    <canvas id="{{name}}" style="width:100%;"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
        (function() {
            const ctx = document.getElementById("{{name}}").getContext('2d');

            const today = new Date();
            const todayString = today.toISOString().split("T")[0];
            const myChart = new Chart(ctx, {
                type: "line",
                data: {
                    datasets: [
                        {% for key in chartdata %}
                            {{create_dataset(key, chartcolors[loop.index], chartdata[key])}},
                        {% endfor %}
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: "time",
                            time: {
                                unit: "month",
                                tooltipFormat: "dd-MMM-yyyy",
                                displayFormats: {
                                    month: "MMM yyyy"
                                }
                            },
                            title: {
                                display: true,
                                text: "Date"
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: "Value"
                            }
                        }
                    },
                }
            });
        })()
    </script>
{% endmacro %}
